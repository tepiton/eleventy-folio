name: Deploy Eleventy to GitHub Pages

on:
  push:
	branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
	runs-on: ubuntu-latest
	steps:
	  - name: Checkout
		uses: actions/checkout@v4

	  - name: Setup Node
		uses: actions/setup-node@v4
		with:
		  node-version: 20
		  cache: npm

	  - name: Install dependencies
		run: npm ci

	  - name: Configure Pages
		uses: actions/configure-pages@v5

	  # Set PATHPREFIX for project pages vs user/org pages:
	  # - If repo name ends with ".github.io", site is at "/" (no prefix)
	  # - Otherwise it's at "/REPO/"
	  - name: Compute path prefix
		shell: bash
		run: |
		  REPO_NAME="${GITHUB_REPOSITORY#*/}"
		  if [[ "$REPO_NAME" == *.github.io ]]; then
			echo "PATHPREFIX=/" >> "$GITHUB_ENV"
		  else
			echo "PATHPREFIX=/$REPO_NAME/" >> "$GITHUB_ENV"
		  fi

	  - name: Build (Eleventy)
		run: npm run build -- --pathprefix="$PATHPREFIX"

	  # Optional but harmless: prevents Jekyll processing edge cases
	  - name: Disable Jekyll
		run: touch _site/.nojekyll

	  - name: Upload Pages artifact
		uses: actions/upload-pages-artifact@v3
		with:
		  path: _site

  deploy:
	runs-on: ubuntu-latest
	needs: build
	environment:
	  name: github-pages
	  url: ${{ steps.deployment.outputs.page_url }}
	steps:
	  - name: Deploy to GitHub Pages
		id: deployment
		uses: actions/deploy-pages@v4
